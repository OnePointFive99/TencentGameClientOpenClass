# 腾讯游戏开发公开课(十):FPS游戏游戏开发基础

# FPS游戏简介

德军总部-3D→毁灭战士→半条命→反恐精英

# FPS游戏基础框架

一个在研游戏的架构

在游戏引擎之上会构建一个GameCore和第三方插件库，然后是一众Manager组成的游戏系统，再向上才是各种玩法和游戏组件

# 武器系统

## 关键基础组件

- 物理引擎

每帧的射线检测，检测即时命中、抛物线轨迹、场景和人物的布料模拟

- 弹道模型
    - 影响弹道的主要因素
        - 主视角角度
        - 后坐力
        - 连发数
        - 精准度
        - 散发度（运动抖动）
    - 连发时，第一枪受到精准度影响，后面垂直方向会收到后坐力抬升，直到最高点（设定一个阈值），这里面精准度和后坐力值都是不一样的
    - 散发度也是与具体武器相关，具体计算考虑随机数
    - 去掉最大后坐力限制的话，视角会上天
- instantHit即时命中武器开火流程

## 武器系统框架

除了刚才的即时命中武器，还有很多其他武器，应该形成系统框架

1. 继承模式
2. 组合模式
3. 武器贴花组件

根据被射击物体材质给出效果

1. 武器动作状态机

# 3C System

> 烟雾弹、闪光弹的实现
> 

由Ubisoft提出的游戏设计概念

- Character：角色，具有一定能力或行为，玩家可以进行扮演或观察
- Camera：相机，玩家通过它观察游戏世界，获得体验感和沉浸感
- Control：为玩家提供不同方式，不同体验的交互

## Character技术要点

- 表现方面：模型、材质、纹理、动画、包围盒、特效、音频、LOD等
- 逻辑方面：角色状态的设计与转换（状态机）
- 细节问题：滑步（动画在走，但是位置没有移动）、转向（模型转向不连贯）

## Camera技术要点

- 渲染顺序：模型穿模时，要注意渲染顺序（unity:camera layer）
- FOV:场景相机的fov和手、枪模型的相机fov是分开的，方便调整枪和开镜的效果
- 碰撞、位置控制
- 屏幕后处理、抖动效果
- TPS和FPS的射击点不一样，FPS可能是从相机出发的射线检测

## Control技术要点

- 不同设备会有差异
- 手游适配问题
    - 同样的代码，IOS与Android灵敏度不同
    - 不同Android手机灵敏度不同
    - 部分Android手机灵敏度偏低
- 辅助瞄准
- 硬件功能适配

# 其他技术点

## 网络同步

- 帧同步与状态同步

帧同步：服务器和客户端有一个校准好的逻辑帧率，服务器每帧收集所有玩家的输入，并帮所有玩家去广播其他人的输入，客户通过同样的方法得到输出

状态同步：只收集一个玩家的输入，由服务器决定新的状态并同步至玩家

帧同步可以用内存快照来改善断线重连性能

FPS是状态同步

# Peeker `s Advantage

由于网络延迟和同步原因，动态拉出来身位的人比静止瞄点更有优势

因为拉出来身位的人看另一个人是静止的，几乎没有网络延迟，所以看到即打

瞄点的人因为另一个人是动态的，所以很容易因为延迟错失击中机会

延迟越低越公平一些，无论动静

# 反外挂

定制外挂(so, dylib)、通用工具(内存修改器、变速器、抓包工具)、辅助类（按键精灵、模拟器、虚拟机）、破解版（脱机挂、破解版客户端）

## 外挂原理

硬件层：显卡驱动（增删显示内容）、网络通信（解密坐标协议）、内存读取（读取坐标内存）

系统层：图像渲染（修改渲染指令及过程）、声音效果（还原声源坐标）

应用层：游戏引擎（读取引擎坐标、修改可见性判定）、游戏逻辑（读取逻辑坐标、修改渲染参数）

## 反外挂方法

- 服务器校验（一些伤害放到服务端判断）
- 服务器数据下发
- 客户端数据加密
- 客户端动态监测

# 性能优化

CPU性能、渲染性能、内存优化、流量优化、卡顿优化

## 物理优化

角色包围盒过于复杂，可以自行设定一个大包围盒，在大包围盒碰撞才检测

## 动画优化

使用LOD

计算骨骼投影大小→update LOD→update 动画

帧率LOD

## GPU Skinning

平衡CPU与GPU的负载

## 渲染

视锥裁剪、距离裁剪（过远不渲染）、LOD、遮挡剔除