# 腾讯游戏开发公开课(四):UI系统

# 简介

UE4提供的界面：

- UMG（常用）
- HUD
- Slate

# Slate

UE4真正的UI解决方案，是从早期就有的，但是编写界面布局非常麻烦

# HUD

可以在屏幕上直接绘制UI，不适合做复杂的东西

# UMG

Unreal Motion Graphics UI Designer 基于Slate构建的界面编辑系统，是对Slate的封装，底层实现还是Slate

可以通过拖拽设计UI，是比Slate更友好的界面编辑器，并且可以在蓝图中进行控制

# UMG基本概念

## 控件Widget

引擎预先封装好的，可以直接拿来使用的一个功能单元。比如: Image、Button

## UI蓝图

编写蓝图代码，控制控件的显示隐藏，调整位置，响应事件等

## 槽Slot

面板控件中用于摆放子控件，包含了定义如何“摆放”的数据信息如CanvasPanel的Slot说明了槽的位置、大小、堆叠次序等信息

## 锚点Anchor

主要用于CanvasPanel的Slot，描述了如何设置槽的位置、大小。直观来看就是子控件相对于父控件的位置关系。

## 可见性

### 折叠

### 隐藏

## 渲染变形

渲染变形可对摆放好的控件进行变形而不用更改布局信息，一般适用于不规则的形状比如菱形或者临时变形(如控件动画)
可应用的变形:
平移、旋转、剪shear、缩放

# 常用控件

## 按钮 (Button)

按钮是单子项、可点击的Primitive控件，它可实现基本交互。你可将任何其他控件放入按钮控件中，以在UI中创建一个更复杂且有趣的可点击元素

## 复选框(Check Box)

借助复选框(Check Box)控件，你可以显示“未选中”“选中”和“不确定”三种切换状态。你可以使用复选框(Check Box)控件来制作经典复选框、切换按钮或单选按钮。

## 图像(lmage)

借助图像(image)控件，你可在UI中显示Slate笔刷、纹理、Sprite或材质

## 进度条(Progress Bar)

进度条(Progress Bar)控件是可以逐渐填充的简单条形，可以重新设计样式以适应各种用途，例如经验值、生命值、分数等。

## 文本(Text)

在屏幕上显示文本的基本方法，可以用于选项或其他UI元素的文本说明。

## 文本框(Text Box)

允许用户输入自定义文本。仅允许输入单行文本

## 面板控件

### 面板(Panel)

类别中包含用于控制布局和放置其他控件的有用控件。

### 画布面板 (Canvas Panel)

允许在任意位置布局、固定控件，并将这些控件与画布的其它子项按z序排序。

### 网格面板 (Grid Panel)

在所有子控件之间平均分割可用空间的面板

### 水平框(Horizontal Box)

用于将子控件水平排布成一行。

### 纵向框(Vertical Box)

用于自动纵向排布子控件。当需要将控件上下堆叠并使控件保持纵向对齐时此控件很有用。

### 滚动框 (Scroll Box)

一组可任意滚动的控件。当需要在一个列表中显示10-100个控件时非常有用。该控件不支持虚拟化。

### 控件切换器(Widget Switcher)

控件切换器类似于选项卡控件，但没有选项卡，你可以自行创建并与此控件组合以获得类似于选项卡的效果。一次最多只显示一个控件。

## 优化控件

### 无效框 (Invalidation Box)

封装在失效框中的控件可以令子控件几何图形进行缓存，以加快平板的渲染速度。任何由无效框缓存的控件都不会进行预处理、绘图或上色。

### 限位框 (Retainer Box)

先将子控件渲染到渲染目标，然后再将该渲染目标渲染到屏幕。使用该选项，你可以控制频率和相位，以使U的实际渲染频率低于主游戏渲染频率。它的附带好处是允许在绘制控件之后将材质应用给渲染目标，以应用简单的后期处理。

中间按钮设置为折叠

# 常用控件

# UI动画

## 如何在UMG创建动画

控件蓝图编辑器的底部有两个窗口，可用来实施和控制I控件的动画。第一个是动画窗口，可以创建用来驱动控件动画的基础动画轨。第二个是时间轴 窗口，用于指定动画如何随时间应用至控件，其方法是在指定的时间上放置关键顿 并定义附加的控件在该关键帧如何显示(可以是尺寸、形状、位置甚至颜色选项)。

### 添加动画轨道

添加一个动画轨。可以在 动画 窗口中单击 +动画 按钮添加动画轨。添加动画后，会收到提示为动画轨输入一个名称。
添加动画轨后，时间轴将会变为可用，并且您可以开始添加 动画关键，动画关键顿与控件随时间改变的值是相关的。同时也请注意每个控件可以有多个动画轨，例如使一个按钮在移过屏幕的同时进行闪烁。

### 添加动画关键帧

- 在支持关键帧的设置旁边单击 添加关键帧 按钮
- 每个设置旁边都有一个图标，可以单击这些图标向时间轴的当前位置添加一个该值的关键帧。
- 背景颜色 的关键帧添加到了 0.00 和2.00，此按钮控件的背景颜色在2秒内由白色变成黄色。

# 使用和控制编辑好的界面

- 蓝图
    - 通过UI蓝图调用设计的界面、动画以及处理用户交互
    - 创建编辑好的UI
    - 控件变量: 通过控件变量来操作控件，设置属性，控件变量可以帮助动态修改UI
    - 调用动画：创建动画的同时也会为其创建一个变量通过变量可以播放、停止动画
    - 事件：绑定事件处理
- lua
    - LUA：调用UI（SLuaunreal插件[GitHub - IriskaDev/slua_unreal_demo](https://github.com/IriskaDev/slua_unreal_demo)）。蓝图的版本控制不方便，不利于多人协作

# 自定义控件（扩展控件库）

### 纯UMG实现

创建控件NewWidget，然后在其他界面使用

### C++实现

1. 实现SNewWidget类 -> 初始化布局 -> 进行事件绑定
2. 实现UNewWidget类 -> 在ReBuildWidget方法中创建SNewWidget实例 -> 在SynchronizeProperties方法中同步U对象与S对象的相应属性
3. 在UMG编辑页面中使用此控件(可参考引擎的Image控件的实现)

# 内存与性能

- 图集
    - 将多个图片素材放在一个图集上，这样可以一个批次画出很多UI图
    - 导入时选择UI的图片压缩方式：UserInterface2D(RGBA)。
    - 使用图集中的单个素材：Sprite Actions -> Extract Sprites
- 内存
- 强引用类型（A在则B一定也在，占据较多内存）：
    - 将一个UMG直接摆放在另一个UMG中
    - UMG使用的变量类型包括其他的UMG
    - 创建UI时选择的类型有UMG
    - 解耦:
        - 避免在蓝图中直接访问类型中的方法，通过基类、接口调用。
        - 不要将各种使用的资源都配置在UI上或者蓝图里，使用弱引用，使用类似MVC的设计模式。
        - 独立实现界面的数据、视图以及控制逻辑。

### 性能优化

- 不用或少用属性绑定
- 尽量不在UI蓝图中实现Tick
- 复杂蓝图逻辑转C++，然后在蓝图中调用C++实现的函数
- 正确设置“隐藏”（hidden和collapsed尽量选择collapsed）
- 无效框：缓存UI绘制的中间数据，减少绘制的CPU消耗
- 合理结构提升渲染性能：
    - 减少UI层次，从而减少UI绘制过程的递归调用
    - 合理规划UI层次，合并图集，批量渲染以减少DrawCall

**本次作业**
1. 为自己的Demo添加游戏界面，其中包含角色的个人信息、基础操作按钮和计分显示。
2. 可选：添加一个得分排行榜，其数据可以使用SaveGame保存在本地，得分进入榜单时可编辑自己在榜单上显示的昵称。