# 腾讯游戏开发公开课(八):AI技术

# 主要内容

1游戏AI技术概述
2.Unreal的游戏AI实现介绍
3.总结

## 读者须已完成前置课程或已了解:

UE4入门
游戏模式

# 什么是AI

学术AI：AI指一个可以观察周遭环境并作出行动以达致成功的系统

游戏AI: 满足玩家在游戏中的体验感

# 基础术语

Player 玩家

Bot 电脑假冒的玩家角色  提升游戏感受

NPC 敌人 对话村民

出色示例：最后生还者 Part2  Dina  循声者

一般来说，游戏AI的目的：

1. 提升玩家的游戏代入感以及各种情感
2. 有趣，强度适中，满足玩家心流的挑战
3. 行为合理，没有明显破绽,
4. 可能需要“真实

## 四大主题

1.  环境感应
2. 知识管理
3. 行为模型
4.  寻路

# 环境感应

- 视野管理(通过物理系统）
- 听觉管理(NavMesh)
- 将复杂环境数据转化为便于AI系统理解的简单中间数据

# 知识管理

- 通过黑板 (Blackboard)来作为数据共享
    - Agent黑板
    - Squad黑板

## 存储

- 消耗大的感应结果
- 寻路结果
- 分帧Plan的部分Plan结果

# 行为模型

没有万金油的行为模型能解决一切AI问题。

了解这些方法的核心思路，有助于选型、组合解决实际AI问题

## 朴素脚本硬编码AI

## 有限状态机

- Finite State Machine，FSM
- 本质是图
- 应用游戏:不计其数(动画控制).
- 原理简单
**一个时刻只处于一个状态
符合条件时跳转状态**
- 弊端：
    - 随着状态增多，状态间跳转可能会平方级增长
    - 状态的重用性差，状态Copy Paste严重

## 分层有限状态机

- 对部分状态机逻辑进行封装
- Hierarchical Finite State Machine. HFSM
- 通过状态分层(分组)，做到状态按组重用
- 应用游戏:不计其数(动画控制)
- 每层都有自己的“历史状态”的引用节点(图中H节点)
- 可嵌套分层 (分组) 的图
- 增加“Watch Building”的状态层
- 重回状态层时，直接进入H所引用的状态
    - 比如进入“Conversation”时，“Watch Building”正处于“Patrolto Safe”，则H也引用该状态退出“Conversation”重回“Watch Building”时，则直接进入之前H记录的“Patrolto Safe”状态

## 行为树

- Behavior Tree
- 本质是树
- 应用游戏:始于Halo2，不计其数
- 节点返回当前执行状态:运行中、已成功、已失败
组合节点(Composite) 有1~N个孩子，其决定直接孩子的执行方式
    - 顺序执行 (Sequence.
    - 选择执行 (Selector)
    - 并行执行(Parallel)
    - 可继承可扩展
- 叶子节点
- 判断节点 (Conditional)”，读取环境信息判断是否符合执行条件。
- 行为行节点(Action)，执行具体行为。
- 节点可被继承为特定功能的节点类型。
    - 比如一个Action是一个状态机，一个判断节点是一个效用决策器

# 效用决策

- Utility Decision System
- 应用游戏:模拟人生
- 例子：蚂蚁军团:现在要扩展领土?还是培育更多兵力?
- 根据环境，个体对每个特性进行归一化评分
    - 人口拥挤程度: 0.9
    - 健康程度: 0.92
    - 培育剩余空间:0.15。
- 为每个特性加上权重，发现扩展的分数0.91大于培育分数0.535，所以最终选择扩展领土的行为，相比之前框架，行为开始显得非常**动态自驱**
- 缺点:可能难以调参

# GOAP

- Goal-Oriented Action Planners，目标导向行为规划
- 应用游戏:F.E.A.R、Fallout3.JustCause2,
- 开发者定义每个行为:先决条件、消耗、结果**运行时后向搜索**:从目标状态开始回溯搜索
- 搜索满足条件的行为列表挑选消耗和最小的行为列表，执行这个行为列表
- 优点:开发者只需配置行为本身，行为序列的建立通过运行时搜索动态建立

# HTN

- HierarchicalTask Networks，层级任务网络
- 应用游戏:上古卷轴、Killzone3、HorizonZeroDawn，......
- 和GOAP有相似之处，但不同点主要在于:
    - 元任务 (Primitive Task) 可组合为组合任务 (Compound Task)
    - 每个任务有自己的条件、行动、结果
    - 运行时前向搜索，不断地搜索符合条件的任务(元任务、组合任务)，直到所有任务都是元任务，得出一个任务列表，执行这个任务列表

## MachineLearning

较少应用于NPC/敌人/队友

- 如何定义“有趣”?
- 不易于满足策划个性化需求
- 需求变化频繁
- 小应用不值得训练
- 未来可期

更多应用于竟技游戏中模仿玩家上，
王者荣耀、穿越火线、CODM

玩法长线，且玩法角色功能变化相对稳定

对称竞技，强化学习训练可用少数数值来反馈。

胜率、KDA

应用于游戏开发过程中的非实时部分

- 动画数据处理
- 运营数据学习

# 模型分层和搭配

# 寻路

a.原始地图

b.按格子离散

c.按waypoint离散

d.按三角形离散，Nav Mesh

# 寻路搜索：重点

## A*算法

1. 将开始节点放入open列表
2. 从open列表挑出低消耗、高启发的节点作为当前搜索节点
3. 当前节点放入close列表，其周边未处理过的节点放入open列表
4. 直到第2步拿出的节点是目标节点

比喻：漆黑环境拿着火把寻路

## Jump Point算法

1. 对A的一种优化
2. A*每次都是展开直接相邻的节点
3. Jump Point不会着急将相邻节点加入到Open列表、而是会跳步到“当前搜索方向临近有障碍物变化“时点

## A*应用到NavMesh

# UNREAL AI实现介绍

- 行为树
- Al Perception
- Environment Query System (EQS)

# 参考：Game AI Pro  UE行为树文档