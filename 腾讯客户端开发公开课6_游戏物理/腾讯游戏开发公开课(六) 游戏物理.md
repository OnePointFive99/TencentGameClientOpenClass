# 腾讯游戏开发公开课(六):游戏物理

- 物理引擎
    - 相关物理引擎
        - NVIDA的PhysX
        - EpicGames的Chaos
        - Bullet Physics等等
- 游戏物理世界的基本构成
    - Body：游戏物理引擎的基本模拟对象，包含一些基本状态如位置，旋转，动量和角动量等等；Body自身没有碰撞功能，碰撞是由Shape决定，一个Body可以有多个Shape
    - Shape
        - 特定解析类型，如Sphere，Capsule，Box和Plane，最常用，效率最高
        - Convex Meshes：凸多边形，性能一般
        - Triangle Meshes：任意多边形，性能较差
        - Height Fields：高程，多用于地形碰撞
    - Simulated：拥有完全模拟特性的body
    - Kinematic：外部驱动的物理体，拥有无限质量，常用于一些按轨迹移动的机关，Kinematic之间没有碰撞
    - Constraint：这是一类抽象实体，用来描述Body自身和Body的运动限制，常见是Joint Constraint

# 物理引擎模拟流程

- Chaos相关

[UE4 Chaos框架解析](https://zhuanlan.zhihu.com/p/342638827)

• Physx相关

[UE4 物理系统实现](https://papalqi.cn/ue4-物理系统实现/)

- 碰撞检测和模拟
- 检测：主要是场景进行相关的碰撞检测，返回查询结果，一般分为三种：
    - RayCast：从一个点射出一条射线
    - Overlap：碰撞体之间的检测
    - Sweep：从一处扫描一个碰撞形体过去
- 模拟：相当于把物体的运动托管给物理系统，不需要任何的接口调用，通过simulate对场景进行模拟

# UE4的物理应用

一个椅子至少可以使用三种shape来表现

## 碰撞Shape类型

### Simple

包括Box/Sphere /Capsule /Convex
支持完整的模拟特性
可用于检测

### Complex

特指TriangleMesh可用于检测
在模拟时，仅支持Kinematic Body

### Simple和Complex可以共存于同一个模型资产和Body上，分别用于不同的用途

## 碰撞通道

- 在同一个物理世界中，经常需要将模拟对象相互隔离，所以要引入碰撞通道的概念-
- Channel(也称为Object Type)和响应关系
    - 一个刚体拥有一个Channel和一张碰撞响应表
    - 对于检测，API会给出反应Channel
    - 对于碰撞，只有两个刚体的碰撞响应表对彼此的Channel都有响应，才会发生碰撞
    - 可以在Project Settings中添加新的通道
- 三种响应
    - lgnore忽略(对检测和碰撞都没有反应)
    - Overlap 重叠(检测时不阻挡射线，模拟时无碰撞)。
    - Block 阻挡(检测时会阻挡射线，模拟时有碰撞).
- 碰撞预设 (也称为Profile)
    - 代表一个刚体的Channel和碰撞响应表组合
    - UE默认提供了一组预设，也可以在Project Settings中添加新的预设
    - 也可以在刚体上自定义
- 注意: Profile和Channel往往拥有同一个名字，但它们不是一回事，不要混淆

## 碰撞视图

可视化及物理场景调试

## 物理材质

- 记录物理参数的资源格式，包含若千个物理相关的参数
- 可被链接在染材质上，方便管理
- 也可直接在蓝图和实例上覆盖

静摩擦和动摩擦系数的实际计算于不同的情况

## Skeletal Mesh Physics

- 骨骼模型的顶点会参与蒙皮动画的计算，位置会随动画变化
- 采用基本几何体和凸包，配合约束作为骨路模型的PhysicsAsset
- 理论上，可以添加Complex/TriangleMesh作为碰撞体，但实践上很少这么做

## 物理动画（应用广泛）

基于动画及真实物理模拟插值的动画系统，应用到骨骼模型上

- 基本刚体+约束组成
- 骨骼动画更新获取骨骼矩阵
- 刚体基于当前数据，模拟之后获取物理数据
- 基于一定权重做动画与真实物理的融合，得出最终的骨骼位置

## Skeletal Mesh Physics

除了角色的Ragdoll，Skeletal Mesh Physics还可以应用在其它场合，比如车辆

## 物理应用层优化

- 降低物理场景的复杂度（缩减body数量）
- 挑选合适的模拟参数
    - 挑选合适的迭代次数
    - 使用合理的帧率
    - 使用简单的约束设定以达到关节效果
- 使用合适的查询方法
    - 降低碰撞盒查询得到的对象数量
    - 降低物理查询本身的损耗
    - 返回单一结果
    - 使用异步方法进行批量查询
- 使用“替代物理”
    - 根据应用场景定制规则
    - 与主物理世界隔离
    - 能进行针对性的优化

- 一些物理相关的基本应用
    - 给模型自定义碰撞：在你想要的模型导入后，如果你想让角色跟模型互动，碰撞可能需要进一步修改
    - 碰撞检测：最常见的就是按F键位交互，打出一条射线获取玩家看向的东西或者射击武器射击功能
    - 碰撞通道：两个碰撞体在游戏世界的交互方式
    - 碰撞视图：可视化及调试物理场景

# 发展方向

Tighter integration with gameplay

Deterministic Simulation

Big World
Deformable
GPU Acceleration
More data driven, more intelligence

# QA

1. 想了解一下 UE5 的奶瓜原理，但代码太多了有些看不懂，老师有什么建议吗
奶瓜不属于Chaos 的部分，不过可以简单回答一下，奶瓜虽然在大部分场合中被用来做粒子特效，但它本质上是一个 GPU 模拟系统及配套的 S hader 代码生成工具。在 研究奶瓜的Runtime 时，可以特别关注 Simulation Stage ，大部分的高阶特性都会围绕这一概念 来实现。
2. 《动物派对》的物理模拟除了软约束和模拟的确定性问题还有哪些可以分析出的物理技术吗？
友商的技术不便作答，但这类游戏不一定需要确定性模拟
3. 老师可以推荐一些动画模拟的读物吗？
《 Foundation of Physically Based Modeling and Animation》
《 Physics for Game Developers》
4. FPS 游戏中的枪械穿模如何解决？我试过调整碰撞预设，但是不论我怎么调整，那杆枪就跟个幽灵一样，似乎物理碰撞根本不起效一样
枪械在手持时并没有启动物理，而是跟着角色动画一起运动，也就是属于 K inematic 模式，和同为 Kin ematic 的墙壁之间自然不会有碰撞。防止穿插有一些别的做法，比如在靠近墙壁时，用动画的方法把枪口抬起来，让枪械的 M esh 尽量位于角色的 Capsule 半径之内
5. 动画和物理的关系，它们之间是怎么相互作用的？
6. 像老师之前说的刺客信条攀爬这种，半动画半模拟的效果在 UE 中具体是如何实现的呢
回答 5 和 6 ：一般流程是这样的，先用动画资产或动画蓝图的输出给物理一个引导 P ose ，物理模拟之后，再按照一定的比例混合到最终的动画 P ose 上 。堕落的绝地武士团在 GDC 上的相关介绍可以一个很好的参考：
[https://www.youtube.com/watch?v=TmAU8aPekEo](https://www.youtube.com/watch?v=TmAU8aPekEo)
7. 动作游戏的战斗是怎样进行碰撞检测的
动作游戏会按照每个打击部位制作专门的碰撞，而不太会直接沿用为 Ragdoll 配置的碰撞体；直接拿近战动画的运动作为攻击轨迹效果上不太稳定，很多时候也会特别配置。
8. 场景破坏是物理的一个重要发展方向吗？这样一个耗性能的过程有什么改进的方法？
介绍几个最常用的手段：
仔细规划碎片数量，避免粒子数量爆棚。利用层级结构 ，缩减同一时间爆出的粒子。设定合理的碎片休眠和生命周期，节省同一时间活动的粒子数量